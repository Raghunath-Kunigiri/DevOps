<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Tailoring - Job Input</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .config-section {
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .config-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .config-section input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .config-section small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }
        
        .input-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 5px;
            background: #f8f8f8;
        }
        
        .mode-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            color: #666;
        }
        
        .mode-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .mode-button:hover {
            background: #e0e0e0;
        }
        
        .mode-button.active:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group.hidden {
            display: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        .required {
            color: #e74c3c;
        }
        
        input[type="text"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 200px;
        }
        
        .xlarge-textarea {
            min-height: 300px;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-reset:hover {
            background: #e0e0e0;
        }
        
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #1565c0;
        }

        .test-connection {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #856404;
        }

        .test-connection button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #ffc107;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .test-connection button:hover {
            background: #ffb300;
        }

        .ats-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            display: none;
        }

        .ats-section.visible {
            display: block;
        }

        .ats-score-display {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 15px 0;
        }

        .ats-score-number {
            font-size: 64px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .ats-score-label {
            font-size: 18px;
            margin-top: 10px;
        }

        .ats-details {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .ats-details h4 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .ats-details ul {
            list-style: none;
            padding: 0;
        }

        .ats-details li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ats-details li:last-child {
            border-bottom: none;
        }

        .btn-check-ats {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            margin-top: 15px;
            width: 100%;
        }

        .btn-check-ats:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-check-ats:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .pdf-upload-section {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .pdf-upload-section h2 {
            color: #333;
            margin-bottom: 10px;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        input[type="file"]:hover {
            border-color: #667eea;
        }

        input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Resume Tailoring - Job Input</h1>
        <p class="subtitle">Provide either a job URL or job description to generate a tailored resume</p>
        
        <div class="config-section">
            <h3>‚öôÔ∏è Configuration (Update if needed)</h3>
            <label for="webhookBaseUrl">Base Webhook URL:</label>
            <input type="text" id="webhookBaseUrl" value="http://192.168.1.199:5678/webhook-test">
            <small>Base URL for your n8n webhooks. Use /webhook-test/ (for test webhooks) or /webhook/ (for production webhooks)</small>
        </div>

        <div class="test-connection">
            <strong>‚ö†Ô∏è Before submitting, test the connection:</strong>
            <button type="button" id="testConnectionBtn">üîç Test Webhook Connection</button>
            <div id="testResult" style="margin-top: 10px;"></div>
        </div>
        
        <!-- PDF Upload Section -->
        <div class="pdf-upload-section">
            <h2 style="margin-bottom: 15px; color: #333; font-size: 22px;">üìÑ Step 1: Upload Your Resume PDF</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                Convert your actual resume PDF to LaTeX format. This will create a base template that will be used for all resume customizations.
            </p>
            
            <div class="form-group">
                <label for="resumePdf">Upload Resume PDF <span class="required">*</span></label>
                <input type="file" id="resumePdf" name="resumePdf" accept=".pdf" required>
                <div class="help-text">Select your resume PDF file (max 10MB). This will be converted to LaTeX.</div>
            </div>
            
            <div class="button-group" style="margin-top: 15px;">
                <button type="button" class="btn-submit" id="uploadPdfBtn">üì§ Upload & Convert to LaTeX</button>
            </div>
            
            <div class="status" id="pdfUploadStatus"></div>
        </div>
        
        <div class="info-box" style="margin-top: 30px;">
            <strong>üí° How it works:</strong> 
            <ol style="margin: 10px 0 0 20px; padding-left: 0;">
                <li>First, upload your resume PDF to convert it to LaTeX (Step 1 above)</li>
                <li>Then, provide job details below to generate a tailored resume</li>
                <li>The workflow will use your LaTeX template to create a customized resume</li>
            </ol>
        </div>
        
        <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
            <h2 style="margin-bottom: 15px; color: #333; font-size: 22px;">üéØ Step 2: Generate Tailored Resume</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                Provide job details to create a customized resume based on your LaTeX template.
            </p>
        </div>
        
        <form id="jobInputForm">
            <div class="input-mode-selector">
                <button type="button" class="mode-button active" data-mode="url" id="modeUrl">
                    üîó Job URL
                </button>
                <button type="button" class="mode-button" data-mode="description" id="modeDescription">
                    üìù Job Description
                </button>
            </div>
            
            <div class="form-group">
                <label for="company_name">Company Name <span class="required">*</span></label>
                <input type="text" id="company_name" name="company_name" required 
                       placeholder="e.g., Google, Microsoft, Amazon">
                <div class="help-text">The name of the company you're applying to</div>
            </div>
            
            <div class="form-group">
                <label for="job_title">Job Title / Role <span class="required">*</span></label>
                <input type="text" id="job_title" name="job_title" required 
                       placeholder="e.g., Senior Software Engineer, DevOps Engineer">
                <div class="help-text">The exact job title from the job posting</div>
            </div>
            
            <!-- URL Mode Fields -->
            <div class="form-group" id="urlModeGroup">
                <label for="job_url">LinkedIn Job URL <span class="required">*</span></label>
                <input type="url" id="job_url" name="job_url" 
                       placeholder="https://www.linkedin.com/jobs/view/1234567890">
                <div class="help-text">Paste the LinkedIn job posting URL (we'll extract the description automatically)</div>
            </div>
            
            <!-- Description Mode Fields -->
            <div class="form-group hidden" id="descriptionModeGroup">
                <label for="job_description">Job Description <span class="required">*</span></label>
                <textarea id="job_description" name="job_description" class="xlarge-textarea" 
                          placeholder="Paste the complete job description here..."></textarea>
                <div class="help-text">Copy and paste the full job description from the posting</div>
            </div>
            
            <div class="form-group">
                <label for="jd_keywords">JD Keywords (Optional)</label>
                <textarea id="jd_keywords" name="jd_keywords" 
                          placeholder="Key skills, technologies, or keywords from the JD (comma-separated or as text)"></textarea>
                <div class="help-text">Important keywords to emphasize (if not provided, will use job description)</div>
            </div>
            
            <div class="form-group">
                <label for="location">Location (Optional)</label>
                <input type="text" id="location" name="location" 
                       placeholder="e.g., San Francisco, CA or Remote">
            </div>
            
            <div class="form-group">
                <label for="employment_type">Employment Type (Optional)</label>
                <input type="text" id="employment_type" name="employment_type" 
                       placeholder="e.g., Full-time, Contract" value="Full-time">
            </div>
            
            <div class="form-group">
                <label for="remote_option">Remote Option (Optional)</label>
                <input type="text" id="remote_option" name="remote_option" 
                       placeholder="e.g., Remote, On-site, Hybrid" value="on-site">
            </div>
            
            <div class="button-group">
                <button type="submit" class="btn-submit" id="submitBtn">üöÄ Generate Tailored Resume</button>
                <button type="reset" class="btn-reset">üîÑ Reset Form</button>
            </div>
        </form>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">Processing your request...</p>
        </div>
        
        <div class="status" id="status"></div>
        
        <!-- ATS Score Section -->
        <div class="ats-section" id="atsSection">
            <h2 style="margin-bottom: 15px; font-size: 24px;">üìä ATS Score Analysis</h2>
            
            <div class="ats-score-display">
                <div class="ats-score-label">Resume ATS Compatibility</div>
                <div class="ats-score-number" id="atsScoreNumber">--</div>
                <div class="ats-score-label" id="atsScoreLabel">Click "Check ATS Score" to analyze</div>
            </div>

            <button type="button" class="btn-submit btn-check-ats" id="checkAtsBtn">
                üìä Check ATS Score
            </button>

            <div class="ats-details" id="atsDetails" style="display: none;">
                <h4>üìã Analysis Details</h4>
                <ul id="atsDetailsList"></ul>
            </div>

            <button type="button" class="btn-submit btn-download-final" id="downloadFinalBtn" style="display: none;">
                ‚¨áÔ∏è Download Your Tailored Resume
            </button>
        </div>
    </div>
    
    <script>
        let currentMode = 'url';
        let currentPdfBlob = null;
        let currentPdfFilename = '';
        let currentJobDescription = '';
        
        // RapidAPI Configuration for ATS Check
        const ATS_API_CONFIG = {
            host: 'resume-ats-analyzer.p.rapidapi.com',
            // Primary API Key
            key: '0cb3aa0239msh26ff201a0d9de33p14a1c1jsn482083ce508a',
            // Alternative API Key (backup)
            keyAlt: 'ecce7b2bbemsh8e42b265aef4901p1c0496jsnfce9e3ab4262',
            statusEndpoint: 'https://resume-ats-analyzer.p.rapidapi.com/api/test/status',
            analyzeEndpoint: 'https://resume-ats-analyzer.p.rapidapi.com/api/analyze'
        };
        
        // Get webhook URLs from config
        function getWebhookBaseUrl() {
            return document.getElementById('webhookBaseUrl').value.trim();
        }
        
        function getUploadPdfWebhookUrl() {
            const baseUrl = getWebhookBaseUrl();
            return `${baseUrl}/upload-resume-pdf`;
        }
        
        function getResumeTailorWebhookUrl() {
            const baseUrl = getWebhookBaseUrl();
            return `${baseUrl}/resume-tailor`;
        }
        
        // PDF Upload functionality
        document.getElementById('uploadPdfBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('resumePdf');
            const pdfFile = fileInput.files[0];
            const statusDiv = document.getElementById('pdfUploadStatus');
            const btn = this;
            const originalText = btn.innerHTML;
            
            if (!pdfFile) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå <strong>Error:</strong> Please select a PDF file to upload.';
                return;
            }
            
            if (pdfFile.size > 10 * 1024 * 1024) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå <strong>Error:</strong> File size exceeds 10MB limit.';
                return;
            }
            
            btn.innerHTML = '‚è≥ Uploading & Converting...';
            btn.disabled = true;
            statusDiv.style.display = 'none';
            
            try {
                const webhookUrl = getUploadPdfWebhookUrl();
                console.log('üì§ Uploading PDF to:', webhookUrl);
                
                const formData = new FormData();
                formData.append('file', pdfFile);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minute timeout for AI processing
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ PDF Conversion Result:', result);
                    
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `‚úÖ <strong>Success!</strong> ${result.message || 'PDF converted to LaTeX successfully!'}<br><br>` +
                        (result.filename ? `üìÑ Template File: ${result.filename}<br>` : '') +
                        (result.file_path ? `üíæ Saved to: ${result.file_path}<br>` : '') +
                        (result.length ? `üìä LaTeX Code Length: ${result.length} characters<br>` : '') +
                        `<br>‚úÖ Your LaTeX template is ready! You can now proceed to Step 2.`;
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå PDF Upload Error:', error);
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                
                let errorMessage = '';
                if (error.name === 'AbortError') {
                    errorMessage = 'Upload timeout. The conversion is taking longer than expected. Please try again.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = `Cannot connect to ${getUploadPdfWebhookUrl()}. Check if the workflow is activated.`;
                } else {
                    errorMessage = error.message;
                }
                
                statusDiv.innerHTML = `‚ùå <strong>Error:</strong> ${errorMessage}`;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // Test connection button
        document.getElementById('testConnectionBtn').addEventListener('click', async function() {
            const testResult = document.getElementById('testResult');
            const btn = this;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '‚è≥ Testing...';
            btn.disabled = true;
            testResult.innerHTML = '';
            
            const webhookUrl = getResumeTailorWebhookUrl();
            
            try {
                console.log('üîç Testing connection to:', webhookUrl);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: true,
                        company_name: 'Test Company',
                        job_title: 'Test Position',
                        job_description: 'This is a test'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    testResult.innerHTML = '<span style="color: #28a745;">‚úÖ Connection successful! Workflow is reachable.</span>';
                } else {
                    testResult.innerHTML = `<span style="color: #dc3545;">‚ùå Connection failed with status ${response.status}. Check if workflow is activated.</span>`;
                }
            } catch (error) {
                console.error('Test error:', error);
                
                let errorMsg = '';
                if (error.name === 'AbortError') {
                    errorMsg = '‚ùå Connection timeout. Check if the URL is correct and n8n is running.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = '‚ùå Network error. Possible issues:<br>' +
                              '‚Ä¢ n8n workflow is not activated<br>' +
                              '‚Ä¢ Wrong IP address or port<br>' +
                              '‚Ä¢ Firewall blocking the connection<br>' +
                              '‚Ä¢ Not on the same network';
                } else {
                    errorMsg = `‚ùå Error: ${error.message}`;
                }
                
                testResult.innerHTML = `<span style="color: #dc3545;">${errorMsg}</span>`;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // Mode selector functionality
        document.querySelectorAll('.mode-button').forEach(button => {
            button.addEventListener('click', function() {
                const mode = this.dataset.mode;
                switchMode(mode);
            });
        });
        
        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            // Show/hide form groups
            const urlGroup = document.getElementById('urlModeGroup');
            const descGroup = document.getElementById('descriptionModeGroup');
            const urlInput = document.getElementById('job_url');
            const descInput = document.getElementById('job_description');
            
            if (mode === 'url') {
                urlGroup.classList.remove('hidden');
                descGroup.classList.add('hidden');
                urlInput.required = true;
                descInput.required = false;
                descInput.value = '';
            } else {
                urlGroup.classList.add('hidden');
                descGroup.classList.remove('hidden');
                urlInput.required = false;
                descInput.required = true;
                urlInput.value = '';
            }
        }
        
        // Form submission
        document.getElementById('jobInputForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const webhookUrl = getWebhookUrl();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Validate based on mode
            if (currentMode === 'url' && !data.job_url) {
                showError('Please provide a LinkedIn job URL');
                return;
            }
            
            if (currentMode === 'description' && !data.job_description) {
                showError('Please provide a job description');
                return;
            }
            
            // Clean up data based on mode
            if (currentMode === 'url') {
                delete data.job_description;
            } else {
                delete data.job_url;
            }
            
            // Show loading
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Processing...';
            submitBtn.disabled = true;
            
            const loadingDiv = document.getElementById('loading');
            const statusDiv = document.getElementById('status');
            
            loadingDiv.style.display = 'block';
            statusDiv.style.display = 'none';
            
            try {
                const webhookUrl = getResumeTailorWebhookUrl();
                console.log('üì§ Sending data to:', webhookUrl);
                console.log('üì§ Payload:', JSON.stringify(data, null, 2));
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type') || '';
                    console.log('üì• Content-Type:', contentType);
                    
                    if (contentType.includes('application/pdf')) {
                        // PDF received - DON'T download yet, store it and check ATS
                        console.log('‚úÖ Received PDF - checking ATS score...');
                        loadingDiv.querySelector('p').textContent = 'PDF generated! Checking ATS score...';
                        
                        const blob = await response.blob();
                        console.log('üì¶ PDF Blob size:', blob.size, 'bytes');
                        
                        // Get filename from header
                        const contentDisposition = response.headers.get('content-disposition') || '';
                        let filename = 'Raghunath_K.pdf';
                        
                        const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/i) ||
                                            contentDisposition.match(/filename="([^"]+)"/i) ||
                                            contentDisposition.match(/filename=([^;]+)/i);
                        
                        if (filenameMatch && filenameMatch[1]) {
                            filename = decodeURIComponent(filenameMatch[1].trim().replace(/['"]/g, ''));
                        }
                        
                        console.log('üìÑ PDF Filename:', filename);
                        
                        // Store for later download
                        currentPdfBlob = blob;
                        currentPdfFilename = filename;
                        currentJobDescription = data.job_description || '';
                        
                        // Hide loading
                        loadingDiv.style.display = 'none';
                        
                        // Show success message
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'status success';
                        statusDiv.innerHTML = `‚úÖ <strong>Success!</strong> Your resume has been generated!<br><br>üìÑ Filename: ${filename}<br>üì¶ Size: ${(blob.size / 1024).toFixed(2)} KB<br><br>‚è≥ Checking ATS compatibility...`;
                        
                        // Show ATS section and start analysis
                        document.getElementById('atsSection').classList.add('visible');
                        
                        // Automatically check ATS score
                        checkATSScore(blob, filename, data.job_description || '');
                    } else {
                        // JSON response
                        const result = await response.json();
                        console.log('üì• Response data:', result);
                        
                        // Hide loading
                        loadingDiv.style.display = 'none';
                        
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'status success';
                        statusDiv.innerHTML = `‚úÖ <strong>Success!</strong> ${result.message || 'Your request has been received and is being processed.'}`;
                        
                        if (result.input_type) {
                            statusDiv.innerHTML += `<br><br>üìã Input Type: ${result.input_type}<br>üè¢ Company: ${result.company}<br>üíº Role: ${result.role}`;
                        }
                        
                        statusDiv.innerHTML += '<br><br>‚è≥ The workflow will process your request. Depending on your workflow configuration, the PDF will be generated soon.';
                    }
                } else {
                    // Error response
                    loadingDiv.style.display = 'none';
                    
                    let errorMsg = 'Unknown error occurred';
                    try {
                        const result = await response.json();
                        errorMsg = result.error || result.message || result.errorMessage || errorMsg;
                    } catch (e) {
                        const text = await response.text();
                        errorMsg = text || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `‚ùå <strong>Error:</strong> ${errorMsg}`;
                }
            } catch (error) {
                console.error('‚ùå Request error:', error);
                document.getElementById('loading').style.display = 'none';
                
                const statusDiv = document.getElementById('status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                
                let errorMessage = '';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout. The server took too long to respond.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = `Network error: Cannot connect to ${getResumeTailorWebhookUrl()}.<br><br>` +
                                 'Possible issues:<br>' +
                                 '‚Ä¢ n8n workflow is not activated (click the toggle in n8n to activate)<br>' +
                                 '‚Ä¢ Wrong webhook URL or port number<br>' +
                                 '‚Ä¢ Firewall or network restrictions<br>' +
                                 '‚Ä¢ Not on the same network as n8n server<br><br>' +
                                 'Try using the "Test Connection" button above to diagnose the issue.';
                } else {
                    errorMessage = error.message;
                }
                
                statusDiv.innerHTML = `‚ùå <strong>Connection Failed:</strong><br><br>${errorMessage}`;
            } finally {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });
        
        function showError(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status error';
            statusDiv.innerHTML = `‚ùå <strong>Error:</strong> ${message}`;
        }
        
        // ATS Check Function - Called automatically when PDF is generated
        async function checkATSScore(pdfBlob, filename, jobDescription) {
            const scoreNumber = document.getElementById('atsScoreNumber');
            const scoreLabel = document.getElementById('atsScoreLabel');
            const detailsDiv = document.getElementById('atsDetails');
            const detailsList = document.getElementById('atsDetailsList');
            
            try {
                console.log('üîç Starting ATS analysis...');
                console.log('üìÑ Filename:', filename);
                console.log('üì¶ PDF Blob size:', pdfBlob.size, 'bytes');
                
                // Update UI to show analyzing state
                scoreNumber.textContent = '...';
                scoreLabel.textContent = 'Analyzing your resume...';
                detailsDiv.style.display = 'none';
                
                // First, check API status
                console.log('üîç Checking ATS API status...');
                const statusResponse = await fetch(ATS_API_CONFIG.statusEndpoint, {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Host': ATS_API_CONFIG.host,
                        'X-RapidAPI-Key': ATS_API_CONFIG.key,
                        'x-rapidapi-host': ATS_API_CONFIG.host,
                        'x-rapidapi-key': ATS_API_CONFIG.keyAlt
                    }
                });
                
                if (!statusResponse.ok) {
                    throw new Error(`API Status Check Failed: ${statusResponse.status}`);
                }
                
                const statusData = await statusResponse.json();
                console.log('‚úÖ API Status:', statusData);
                
                // Upload PDF and analyze
                console.log('üì§ Uploading PDF for analysis...');
                const formData = new FormData();
                formData.append('resume', pdfBlob, filename);
                
                if (jobDescription) {
                    formData.append('job_description', jobDescription);
                }
                
                const analyzeResponse = await fetch(ATS_API_CONFIG.analyzeEndpoint, {
                    method: 'POST',
                    headers: {
                        'X-RapidAPI-Host': ATS_API_CONFIG.host,
                        'X-RapidAPI-Key': ATS_API_CONFIG.key,
                        'x-rapidapi-host': ATS_API_CONFIG.host,
                        'x-rapidapi-key': ATS_API_CONFIG.keyAlt
                        // Note: Don't set Content-Type header - browser will set it with boundary for FormData
                    },
                    body: formData
                });
                
                if (!analyzeResponse.ok) {
                    const errorText = await analyzeResponse.text();
                    console.error('‚ùå Analysis failed:', errorText);
                    throw new Error(`Analysis failed: ${analyzeResponse.status} - ${errorText.substring(0, 100)}`);
                }
                
                const analyzeData = await analyzeResponse.json();
                console.log('‚úÖ Analysis result:', analyzeData);
                
                // Display results
                const score = analyzeData.score || analyzeData.ats_score || analyzeData.compatibility_score || null;
                const scorePercentage = score !== null ? Math.round(score) : null;
                
                if (scorePercentage !== null) {
                    scoreNumber.textContent = scorePercentage;
                    
                    // Color code based on score
                    if (scorePercentage >= 80) {
                        scoreLabel.textContent = 'Excellent ATS Compatibility!';
                        scoreNumber.style.color = '#4ade80';
                    } else if (scorePercentage >= 60) {
                        scoreLabel.textContent = 'Good ATS Compatibility';
                        scoreNumber.style.color = '#fbbf24';
                    } else {
                        scoreLabel.textContent = 'Needs Improvement';
                        scoreNumber.style.color = '#f87171';
                    }
                } else {
                    scoreNumber.textContent = '‚úì';
                    scoreLabel.textContent = 'Analysis Complete';
                }
                
                // Show details
                detailsDiv.style.display = 'block';
                let detailsHTML = '';
                
                if (analyzeData.matches || analyzeData.keywords || analyzeData.suggestions) {
                    if (analyzeData.matches) {
                        detailsHTML += `<li><strong>Matched Keywords:</strong> ${Array.isArray(analyzeData.matches) ? analyzeData.matches.join(', ') : analyzeData.matches}</li>`;
                    }
                    if (analyzeData.keywords) {
                        detailsHTML += `<li><strong>Keywords:</strong> ${Array.isArray(analyzeData.keywords) ? analyzeData.keywords.join(', ') : analyzeData.keywords}</li>`;
                    }
                    if (analyzeData.suggestions) {
                        detailsHTML += `<li><strong>Suggestions:</strong> ${Array.isArray(analyzeData.suggestions) ? analyzeData.suggestions.join(', ') : analyzeData.suggestions}</li>`;
                    }
                }
                
                // Add any other fields from the response
                Object.keys(analyzeData).forEach(key => {
                    if (!['score', 'ats_score', 'compatibility_score', 'matches', 'keywords', 'suggestions'].includes(key)) {
                        const value = typeof analyzeData[key] === 'object' ? JSON.stringify(analyzeData[key]) : analyzeData[key];
                        detailsHTML += `<li><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}</li>`;
                    }
                });
                
                if (!detailsHTML) {
                    detailsHTML = `<li><strong>Analysis complete!</strong> Check the API response for more details.</li>`;
                }
                
                detailsList.innerHTML = detailsHTML;
                
                // Show download button
                document.getElementById('downloadFinalBtn').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå ATS Check Error:', error);
                scoreNumber.textContent = '‚úó';
                scoreLabel.textContent = 'Error analyzing resume';
                detailsDiv.style.display = 'block';
                detailsList.innerHTML = `
                    <li><strong>Error:</strong> ${error.message}</li>
                    <li><strong>Note:</strong> Make sure your RapidAPI keys are correct and the API is accessible. You may need to check the RapidAPI documentation for the exact endpoint format.</li>
                `;
                
                // Still show download button even on error
                document.getElementById('downloadFinalBtn').style.display = 'block';
            }
        }
        
        // Download button handler
        const downloadBtn = document.getElementById('downloadFinalBtn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                if (!currentPdfBlob) {
                    showError('PDF not available for download. Please generate a new resume.');
                    return;
                }
                
                const url = window.URL.createObjectURL(currentPdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = currentPdfFilename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                console.log('‚úÖ PDF downloaded:', currentPdfFilename);
            });
        } else {
            console.warn('Download button not found in HTML');
        }
    </script>
</body>
</html>